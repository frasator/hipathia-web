<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<script src="bower_components/cookies-js/dist/cookies.min.js"></script>
<script src="bower_components/crypto-js/core.js"></script>
<script src="bower_components/crypto-js/sha1.js"></script>


<link rel="import" href="bower_components/stevia-components/src/stv-header.html">
<link rel="import" href="bower_components/stevia-components/src/stv-application-behavior.html">
<link rel="import" href="bower_components/stevia-components/src/stv-footer.html">
<link rel="import" href="bower_components/stevia-components/src/stv-help-menu.html">
<link rel="import" href="bower_components/stevia-components/src/stv-select.html">
<link rel="import" href="bower_components/stevia-components/src/stv-select-box.html">
<link rel="import" href="bower_components/stevia-components/src/stv-panel.html">
<link rel="import" href="bower_components/stevia-components/src/dropdown/stv-dropdown.html">

<link rel="import" href="bower_components/stevia-components/src/table/stv-table.html">
<link rel="import" href="bower_components/stevia-components/src/form/stv-file-origin.html">
<link rel="import" href="bower_components/stevia-components/src/file/stv-file-browser.html">
<link rel="import" href="bower_components/stevia-components/src/job/stv-job-browser.html">

<script src="bower_components/stevia-components/src/validator/expression-validator.js"></script>

<link rel="import" href="src/hipathia-home.html">
<link rel="import" href="src/hipathia-signaling-form.html">
<link rel="import" href="src/hipathia-prediction-form.html">
<link rel="import" href="src/hipathia-result.html">

<dom-module id="hipathia-element">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning"></style>
    <style>
        :host {
            display: block;
            position: relative;
            cursor: default;
            font-size: 13px;
            background-color: var(--default-primary-color);
            height: 100%;
            width: 100%;
        }

        stv-header {
            position: absolute;
            top: 0;
        }

        stv-footer {
            position: absolute;
            bottom: 0;
        }

        .content {
            position: absolute;
            width: 100%;
            top: 60px;
            /*height: calc(100vh - 60px);*/
            /*background-color: transparent;*/
        }

        #fileBrowserPanel {
            position: absolute;
            top: 0px;
            left: 0;
            width: 600px;
            height: 400px;
            min-width: 600px;
            min-height: 400px;
        }

        #jobBrowserPanel {
            position: absolute;
            top: 0px;
            right: 0;
            width: 600px;
            height: 400px;
            min-width: 600px;
            min-height: 400px;
        }

        #fileBrowser {}

        #jobBrowser {}

        @media (max-width: 1100px) {
            .option-text {
                display: none;
            }
        }

        .userid {
            color: var(--accent-color);
            font-size: 16px;
        }

        #description {
            color: var(--accent-color);
            font-weight: normal;
        }

        hipathia-home {
            height: calc(100vh - 160px);
            overflow-y: auto;
        }

        hipathia-prediction-form,
        hipathia-signaling-form,
        hipathia-result {
            height: calc(100vh - 60px);
            overflow-y: auto;
        }
    </style>
    <template>

        <div class="content" menu-option="home">
            <hipathia-home id="home" on-start="handleHomeStart" isLogged="{{isLogged}}"></hipathia-home>
        </div>

        <div id="jobContent" class="content" menu-option="job">
        </div>

        <div class="content" menu-option="home,job,signaling,prediction">
            <stv-panel id="fileBrowserPanel" hidden collapsible movable closable resizable on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-cloud"></i>&nbsp; Browse my data
                </div>
                <stv-file-browser id="fileBrowser" class="container flex" on-fileselect="handleFileSelect" bioformats="{{bioformats}}" on-need-refresh="handleUserNeedRefresh" user-data="{{userData}}">
                </stv-file-browser>
            </stv-panel>
            <stv-panel id="jobBrowserPanel" hidden collapsible movable closable on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-flask"></i>&nbsp; Browse my jobs
                </div>
                <stv-job-browser id="jobBrowser" class="container flex" on-jobselect="handleJobSelect" allowed-tools="{{allowedTools}}" on-need-refresh="handleUserNeedRefresh" user-data="{{userData}}" disable-relaunch="{{disableRelaunch}}" hide-status-filter="{{hideStatusFilter}}"
                    hide-tool-filter="{{hideToolFilter}}">
                </stv-job-browser>
            </stv-panel>
        </div>

        <div class="content" menu-option="signaling">
            <hipathia-signaling-form id="signalingForm" selectedOption="{{selectedOption}}" bioformats="{{bioformats}}" user-data="{{userData}}" on-job-launched="handleJobLaunched"></hipathia-signaling-form>
        </div>

        <div class="content" menu-option="prediction">
            <hipathia-prediction-form id="predictionForm" selectedOption="{{selectedOption}}" bioformats="{{bioformats}}" user-data="{{userData}}" on-job-launched="handleJobLaunched"></hipathia-prediction-form>
        </div>

        <stv-header id="stvHeader" hide-jobs hide-browse selected-option="{{selectedOption}}" user-data="{{userData}}" on-login="handleLogin" on-logout="handleLogout">
            <div class="icon">
                <img src="images/icon.svg" style="height: 54px;margin: 8px 3px 0 0;">
            </div>
            <div class="title horizontal layout center" style="margin-left:15px;">
                <div>hi</div>
                <div style="font-weight:normal">P</div>
                <div>athia</div>
            </div>
            <span id="description" class="description">
                Pathways analysis suite
            </span>

            <div id="menu" class="menu horizontal layout flex">
                <!-- <div class="flex"></div> -->

                <div style="margin-left:4vw;"></div>
                <div title="Open differential signaling form" class="option" on-click="handleLoggedOnlyMenuOption" data-option="signaling">
                    <i class="fa fa-magic"></i>
                    <span class="option-text">Differential signaling</span>
                </div>
                <div title="Open prediction form" class="option" on-click="handleLoggedOnlyMenuOption" data-option="prediction">
                    <i class="fa fa-magic"></i>
                    <span class="option-text">Prediction</span>
                </div>

                <div class="flex" style="margin-left:2vw;"></div>
                <div title="Browse my data" class="option" on-click="handleLoggedOnlyMenuPanel" show-on-login data-panel="fileBrowserPanel">
                    <i class="fa fa-cloud"></i>
                    <span class="option-text">My data</span>
                </div>
                <div title="Browse my jobs" class="option" on-click="handleLoggedOnlyMenuPanel" show-on-login data-panel="jobBrowserPanel">
                    <i class="fa fa-flask"></i>
                    <span class="option-text">My jobs</span>
                </div>
                <div style="margin-left:2vw;"></div>
            </div>

            <stv-dropdown dark class="helpmenu">
                <div data-button><i class="fa fa-question-circle"></i></div>
                <ul data-menu>
                    <a href="http://hipathia.babelomics.org/doc" target="_blank">
                        <li>
                            <i class="fa fa-book"></i> &nbsp; Documentation
                        </li>
                    </a>
                    <li data-divider></li>
                    <li>
                        <div on-mousedown="handleExample" data-example-name="differential-signaling">
                            <i class="fa fa-lightbulb-o"></i> &nbsp; Differential signaling example
                        </div>
                    </li>
                    <li>
                        <div on-mousedown="handleExample" data-example-name="prediction-train">
                            <i class="fa fa-lightbulb-o"></i> &nbsp; Prediction train example
                        </div>
                    </li>
                    <li>
                        <div on-mousedown="handleExample" data-example-name="prediction-test">
                            <i class="fa fa-lightbulb-o"></i> &nbsp; Prediction test example
                        </div>
                    </li>
                </ul>
            </stv-dropdown>
        </stv-header>

        <stv-footer menu-option="home,login,signup,profile,remember">
            hi<b>P</b>athia
            <br> Created by
            <span style="font-weight:bold;">Computational Genomics Department</span>
            <br> Principe Felipe Research Center, Valencia, Spain
            <br> 2016
        </stv-footer>
    </template>

    <script>
        Polymer({
            is: "hipathia-element",
            behaviors: [StvApplicationBehavior],
            properties: {
                bioformats: {
                    type: Array,
                    notify: true,
                    value: [{
                        value: 'DATAMATRIX_EXPRESSION',
                        text: 'Data matrix expression',
                        validator: ExpressionValidator
                    }, {
                        value: 'VARIANT',
                        text: 'Variant (VCF)',
                        validator: VCFValidator
                    }, {
                        value: 'IDLIST',
                        text: 'Experimental design'
                    }, ]
                },
                allowedTools: {
                    type: Array,
                    value: function() {
                        return ['pathways.differential-signaling', 'pathways.prediction-train', 'pathways.prediction-test'];
                    }
                },
            },
            ready: function() {
                var me = this;
                this.selectedOption = "home";
                this.checkShowMenuOnLogin();
            },
            handleFileSelect: function(e) {},
            handleJobSelect: function(e) {
                var me = this;
                var job = e.detail;
                if (job && job.status === 'DONE') {
                    while (this.$.jobContent.firstChild) {
                        this.$.jobContent.removeChild(this.$.jobContent.firstChild);
                    }
                    this.set('selectedOption', 'job');
                    // var result = document.createElement( execution + '-result');
                    var result = document.createElement('hipathia' + '-result');
                    Polymer.dom(me.$.jobContent).appendChild(result);
                    result.set('job', job);
                }
            },
            handleJobLaunched: function() {
                this.setMenu('home');
                this.$.jobBrowserPanel.show();
                this.$.stvHeader.getUserInfo(true);
            },
            handleLogin: function() {
                this.selectedOption = "home";
                if (this._lastLogedRequest) {
                    this._lastLogedRequest.hidden = false;
                    this._lastLogedRequest = null;
                }

                this.$.home.isLogged = true;
                this.checkShowMenuOnLogin();
            },
            handleLogout: function() {
                this.$.home.isLogged = false;
                this.setMenu('home');
                this.checkShowMenuOnLogin();
            },
            handleUserNeedRefresh: function() {
                this.$.stvHeader.getUserInfo(true);
            },
            handleHomeStart: function() {
                if (this.$.stvHeader.isLogged != true) {
                    this.$.stvHeader.anonymousSign();
                }
                this.setMenu('signaling');
            },

            // handleExample: function(e) {
            //     if (this.$.jsoHeader.isLogged != true) {
            //         this._lastExampleRequest = e.currentTarget.dataset['exampleName'];
            //         this.$.jsoHeader.anonymousSign();
            //     } else {
            //         this.runExample(e.currentTarget.dataset['exampleName']);
            //         this.$.jobsPanel.show();
            //     }
            // },
            // runExample: function(exname) {
            //     if (exname === 'differential-signaling') {
            //         this.$.signalingForm.runExample();
            //     }
            //     if (exname === 'prediction-train') {
            //         this.$.predictionForm.runTrainExample();
            //     }
            //     if (exname === 'prediction-test') {
            //         this.$.predictionForm.runTestExample();
            //     }
            // },

            handleLaunchTest: function(e) {
                var me = this;
                console.log('Launch test');
                var query = {
                    sid: Cookies("bioinfo_sid"),
                    name: 'El job',
                    description: 'la desc',
                    outdirId: '56cae4eba1276eac042b53a4',
                };
                var jobConfig = {
                    tool: 'test',
                    execution: 'test',
                    executable: 'test.sh',
                    options: {
                        input1: {
                            type: 'file',
                            mode: 'id',
                            value: '56cb2edf5ef99403282a7640'
                        },
                        input2: {
                            type: 'file',
                            mode: 'text',
                            value: 'test input 2\nthis file is text'
                        },
                        outdir: {
                            out: true,
                        },
                        param1: {
                            type: 'text',
                            value: 'param1val'
                        },
                        f: {
                            type: 'flag',
                            short: true
                        }
                    }
                };

                /**/
                /**/
                var query = {
                    sid: Cookies("bioinfo_sid"),
                    name: 'Differential signaling job',
                    description: 'test diff sign',
                    outdirId: '56e6d0ed5d07cb333f39f6d0'
                };
                var jobConfig = {
                    tool: 'pathways',
                    execution: 'differential-signaling',
                    executable: 'differential-signaling.sh',
                    options: {
                        "exp_file": {
                            type: 'file',
                            mode: 'id',
                            value: '56e6c91d67fd4ad8567b5e4c'
                        },
                        "design_file": {
                            type: 'file',
                            mode: 'id',
                            value: '56e6c919ff6002ce567adada'
                        },
                        "output_folder": {
                            out: true,
                        },
                        cond1: {
                            type: 'text',
                            value: 'Normal'
                        },
                        cond2: {
                            type: 'text',
                            value: 'Tumor'
                        },
                        // "pathways_list": {
                        //     type: 'text',
                        //     value: "04014,04015,04010,04012,04310,04330,04340,04350,04390,04370,04630,04064,04668,04066,04068,04020,04071,04024,04022,04151,04152,04150,04110,04114,04210,04115,04510,04520,04530,04540,04611,04620,04621,04622,04650,04660,04662,04664,04666,04670,04062,04910,04922,04920,03320,04912,04915,04914,04921,04919,04916,04261,04270,04722,05200,05231,05202,05205"
                        // },
                        "pathways_list": {
                            type: 'text',
                            value: "04014"
                        },
                        "species": {
                            type: 'text',
                            value: "hsa"
                        },
                        "design_type": {
                            type: 'text',
                            value: "categorical"
                        },
                        "verbose": {
                            type: 'flag'
                        }
                    }
                };

                SteviaManager.jobs.create({
                    query: query,
                    request: {
                        method: 'POST',
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(jobConfig),
                        success: function(response) {
                            if (response.response[0].error == null) {
                                console.log(response);
                            } else {
                                console.log(response.response[0].error);
                            }
                            me.handleUserNeedRefresh();
                        },
                        error: function() {
                            console.log('Server error, try again later.');
                        }
                    }
                });
            }
        });
    </script>
</dom-module>
